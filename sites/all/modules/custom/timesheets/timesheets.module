<?php
 

/**
*@file
* Helps devs to study.
*\
/**
 * Implements hook_form_alter().
*/
function timesheets_menu() {
    $items = array (); 
    $items['user/%user/timesheets/week/ajax/%ctools_js/%/%'] = array(
        'title' => 'add Timesheet',
        'page callback' => 'ajax_modal_timesheets_forms_page_callback',
        'page arguments' => array(5),
        'access callback' => TRUE, 
          'modal' => TRUE, // This line is where the magic happens.
    );
     return $items;
}


 function ajax_modal_timesheets_forms_page_callback($js = NULL) {
    if ($js) {
 
    ctools_include('ajax');
    ctools_include('modal');
  
    $form_state = array(
      'ajax' => TRUE,
      'title' => 'Add a timesheet',
    );
 
    $commands = ctools_modal_form_wrapper('add_timesheet_form', $form_state);
    
    print ajax_render($commands);
    }
    else {
    return drupal_get_form('add_timesheet_form');
    }
}

 

function add_timesheet_form($form, &$form_state) {
    $uid = arg(1);
    $ticket_nid = arg(6);
    $date = arg(7);
    
    $date_parts = explode ('_', $date);
    $date = '20' . $date_parts[2] . "-" . $date_parts[1] . "-" . $date_parts[0];
   
    global $user;
    $current_roles = $user->roles;
    $access_value = get_access_admin_value($current_roles);
    $form = array();
    $hours =array(1,2,3,4,5,6,7,8,9,10,11,12);
    if ($access_value > 0) {
             // creating menu fields
            $form['hours'] = array(
                '#type' => 'select',
                '#title' => t('Spent hours') ,
                   '#default_value' => $hours[6],
                '#options' => $hours,
                '#description' => t('Choose the user that you want to be added to the team.'),
             

                );
            
            
            $form['body'] = array(
                '#type' => 'textfield',
                '#title' => t('Comment') ,
                '#attributes' => array('placeholder' => t('Your comment should go here!') ),
                '#description' => t('hidden field for submit function'),
                
                );
            
            
                    
            $form['ticket_nid'] = array(
                  '#type' => 'hidden',
                '#title' => t('Ticket\'s nid') ,
                '#value' => $ticket_nid,
                '#description' => t('hiiden field for submit function'),
                
                );
           
             $form['date'] = array(
                 '#type' => 'hidden',
                '#title' => t('Date') ,
                '#value' => $date,
                '#description' => t('hidden field for submit function'),
                
                );
             
              $form['user'] = array(
               '#type' => 'hidden',
                '#title' => t('User\'s uid') ,
                '#value' => $uid,
                '#description' => t('hidden field for submit function'),
                
                );
            
            // adding the button
            $form['submit'] = array(
                '#type' => 'submit',
     
                '#value' => t('Add a timesheet'),
                '#prefix' => '<div id="add_to_team_custom">',
                '#suffix' => '</div>',
                '#ajax' => array(
                  'callback' => 'ajax_form_add_timesheet_form_submit',
                  'event' => 'click',
                    ),
                   );
     
     
            $form['submit']['#submit'][] = 'add_timesheet_form_submit';
            $form['#attributes'] = array('class' => 'add_timesheet_custom');

       
       
    }
    else {
         $message3 = t('Only Project Managers and Admins can');
        $form['textfield3'] = array(
            '#type' => 'textfield',
            '#size' => 34,
            '#value' => $message3,
            '#attributes' => array(
                'readonly' => 'readonly'
            ) ,
        );
       
       
    }
     
    return $form;
}
function add_timesheet_form_validate($form, &$form_state) {
}
function add_timesheet_form_submit($form, &$form_state) {
 
 $hours_spent = $form_state['values']['hours']+1;
 $ticket_nid = $form_state['values']['ticket_nid']; 
 $user_uid = $form_state['values']['user'];
 $date = $form_state['values']['date'];    
 
 $comment = $form_state['values']['body'];    

  $new_timesheet = _create_new_timesheet($user_uid,$ticket_nid,$hours_spent,$date,$comment);
 
  
  //drupal_set_message('<pre>'. print_r($date, true) .'</pre>');  

}
     
     
 function ajax_form_add_timesheet_form_submit($form, &$form_state) {
          ctools_include('ajax');
          ctools_include('modal');
          ctools_modal_add_js(); 

         
          $commands = array();
        //  $commands[] = ajax_command_invoke(NULL, "reload_view"  );
          $commands[] = ctools_modal_command_dismiss();
          return array(
            '#type' => 'ajax',
            '#commands' => $commands,
          );

}



function _create_new_timesheet($user_uid, $ticket_nid, $hours_spent, $date, $comment) {
  
    global $user; 
    
    
    $date_field = array(
        'value' => $date,
        'timezone' => 'Europe/Helsinki',
        'timezone_db' => 'Europe/Helsinki',
        'date_type' => 'date',
    );
    
 

  $node = new stdClass();
  $node->title = "user's " . $user_uid . " Timesheet for ticket " . $ticket_nid . ' and date ' . $date;
  $node->type = "timesheet";
  // Sets some defaults. Invokes hook_prepare() and hook_node_prepare().
  node_object_prepare($node); 
  // Or e.g. 'en' if locale is enabled.
  $node->language = LANGUAGE_NONE; 
  $node->uid = $user->uid; 
  // Status is 1 or 0; published or not.
  $node->status = 0; 
  // Promote is 1 or 0; promoted to front page or not.
  $node->promote = 0; 
  // Comment is 0, 1, 2; 0 = disabled, 1 = read only, or 2 = read/write.
  $node->comment = 0; 

  // Text field
  $node->field_time_spent[$node->language][]['value'] = $hours_spent;
  $node->body[$node->language][]['value'] = $comment;

   // Entity reference field.
  $node->field_ticket_reference[$node->language][] = array(
    'target_id' => $ticket_nid,
    'target_type' => 'node',
  );
  $node->field_user_reference[$node->language][0]['uid'] = $user_uid;
  // date field
  $node->field_date_created[$node->language][0] =   $date_field;

 

  $node = node_submit($node); // Prepare node for saving
  node_save($node);
}





